<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Matematik Oyunu</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>

<style>
  :root{
    --parchment:#f6efe1; --paper:#fffdf6; --ink:#2b1d0e; --muted:#6b5641;
    --gold:#b38a3e; --border:#d8c7a3; --ok:#2e7d32; --warn:#d97706; --danger:#b91c1c;
  }
  *{box-sizing:border-box}
  body{margin:0; color:var(--ink); font-family:"Libre Baskerville", Georgia, serif;
    background:
      radial-gradient(1200px 700px at 50% 0%, #f8f1e6 0%, #efe3cd 60%, #e6d5b5 100%),
      repeating-linear-gradient(10deg, #0000 0 24px, #00000006 24px 25px);
  }

  .shell{max-width:1100px; margin:24px auto; padding:24px; background:var(--parchment);
    border:1px solid var(--gold); border-radius:10px; box-shadow:0 14px 40px rgba(0,0,0,.18); position:relative;
  }
  .shell::before{content:""; position:absolute; inset:10px; border:3px double var(--gold); border-radius:8px; pointer-events:none;}

  /* ÜST PANEL (yatay şerit) */
  .topbar{
    background:var(--paper); border:1px solid var(--border); border-radius:10px;
    padding:10px 12px; display:grid; grid-template-columns: 1fr auto auto; gap:10px; align-items:center;
    box-shadow: inset 0 0 0 1px #ffffff80;
    margin-bottom:14px;
  }
  .ctrls{display:flex; gap:8px; flex-wrap:wrap}
  .input, .btn{
    padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#fffdf9; font-size:14px;
  }
  .btn{font-weight:700; background:linear-gradient(#e9d6a6,#d6b86a); border-color:#8a6a2a; cursor:pointer}
  .btn:hover{filter:brightness(1.04)}
  .pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fffdf9; font-size:14px}
  .timerWrap{min-width:160px}
  .barWrap{height:8px; background:#efe6d1; border:1px solid var(--border); border-radius:999px; overflow:hidden}
  .bar{height:100%; width:100%; background:linear-gradient(90deg,#b38a3e,#caa75b)}

  /* KAĞIT ÇERÇEVE + CANVAS */
  .paper{
    background:var(--paper); border:1px solid var(--border); border-radius:6px; padding:16px;
    box-shadow: inset 0 0 0 1px #ffffff80, 0 10px 24px rgba(0,0,0,.12);
  }
  .canvasBox{position:relative}
  #canvas{display:block; width:100%; height:auto; background:#fff; border:2px solid #d9c9a8}

  <!-- ===== Graph Controls (non-breaking) ===== -->
<section id="graph-controls" class="panel">
  <div class="row">
    <label for="funcInput" title="Ör: sin(x), x*x+3, cos(x/2)">
      f(x)
    </label>
    <input id="funcInput" type="text" placeholder="ör: sin(x) + x/3" autocomplete="off" />
  </div>

  <div class="row">
    <label for="xMin" title="Grafiğin sol sınırı">x min</label>
    <input id="xMin" type="number" step="0.1" value="-10" />
    <label for="xMax" title="Grafiğin sağ sınırı" style="margin-left:.5rem">x max</label>
    <input id="xMax" type="number" step="0.1" value="10" />
    <label for="samples" title="Çizim çözünürlüğü (nokta sayısı)" style="margin-left:.5rem">örnek</label>
    <input id="samples" type="number" min="100" max="5000" value="800" />
  </div>

  <div class="row">
    <label for="strokeColor" title="Çizgi rengi">renk</label>
    <input id="strokeColor" type="color" value="#3b82f6" />
    <label for="strokeWidth" title="Çizgi kalınlığı" style="margin-left:.5rem">kalınlık</label>
    <input id="strokeWidth" type="number" min="1" max="10" value="2" />
  </div>

  <div class="row hint">
    <span>İpucu: <code>sin(x)</code>, <code>cos(x)</code>, <code>tan(x)</code>, <code>sqrt(x)</code>, <code>abs(x)</code>, <code>log(x)</code> kullanabilirsin.</span>
  </div>
</section>

<!-- Küçük canlı önizleme alanı -->
<section id="preview-wrap">
  <canvas id="previewCanvas" width="320" height="200"></canvas>
</section>

  

  /* SAĞ-ALT SKOR KARTI (yüzen) */
  .scores{
    position:fixed; right:24px; bottom:24px; width:260px;
    background:var(--paper); border:1px solid var(--border); border-radius:12px; padding:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.18), inset 0 0 0 1px #ffffff80;
  }
  .scores h3{margin:0 0 8px; font-size:16px; border-bottom:1px solid var(--border); padding-bottom:6px}
  .row{display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed #e4d7bf}
  .row:last-child{border-bottom:0}

  /* Tahmin girişi sadece viewer'a */
  .guess{display:flex; gap:8px; align-items:center}
  .hide{display:none !important}
  @media (max-width: 1200px){ .scores{position:absolute; right:16px; bottom:16px} }

  #graph-controls.panel{background:#fffdf6;border:1px solid #e8e2d2;border-radius:14px;padding:10px;margin:8px 0;font-family:system-ui,Segoe UI,Roboto,Arial}
  #graph-controls .row{display:flex;align-items:center;gap:.5rem;margin:.35rem 0;flex-wrap:wrap}
  #graph-controls label{font-size:.92rem;color:#3b2c1f}
  #graph-controls input[type="text"], #graph-controls input[type="number"]{
    border:1px solid #d5cdbd;border-radius:10px;padding:.45rem .6rem;min-width:8rem;outline:none
  }
  #graph-controls input[type="color"]{width:2.2rem;height:2.2rem;padding:0;border:none;background:transparent}
  #graph-controls .hint{font-size:.85rem;color:#6b5641}
  #preview-wrap{display:flex;justify-content:flex-start;gap:.75rem;align-items:center;margin:6px 0}
  #previewCanvas{background:#ffffff;border:1px dashed #d3cbb9;border-radius:12px
</style>
</head>

<body>
<div class="shell">
  <!-- Üst panel -->
  <div class="topbar">
    <!-- 1) Çizim kontrolleri (sadece painter aktif) -->
    <div class="ctrls" id="drawCtrls">
      <input id="expr" class="input" placeholder="y=sin(x) veya (x^2 + y^2 = 9)" />
      <input id="xmin" class="input" style="width:90px" placeholder="x min" value="-10" />
      <input id="xmax" class="input" style="width:90px" placeholder="x max" value="10" />
      <input id="dx" class="input" style="width:80px" placeholder="dx" value="0" />
      <input id="dy" class="input" style="width:80px" placeholder="dy" value="0" />
      <input id="theta" class="input" style="width:100px" placeholder="θ (derece)" value="0" />
      <button id="send" class="btn">Gönder</button>
      <button id="clear" class="btn">Temizle</button>
    </div>

    <!-- 2) Kelime (painter'a açık), Viewer'a “?” -->
    <div class="pill" id="wordBox">Kelime: <span id="wordTxt">?</span></div>

    <!-- 3) Sayaç -->
    <div class="timerWrap">
      <div style="display:flex; justify-content:space-between; font-weight:700; margin-bottom:4px">
        <span>Süre</span><span id="countdown">03:00</span>
      </div>
      <div class="barWrap"><div id="timebar" class="bar"></div></div>
    </div>
  </div>

  <!-- Canvas (defter sayfası) -->
  <div class="paper">
    <div class="canvasBox">
      <canvas id="canvas" width="900" height="600"></canvas>
    </div>
  </div>

  <!-- Tahmin (yalnız viewer) -->
  <div class="topbar" id="guessBar">
    <div class="guess">
      <strong>Tahmin:</strong>
      <input id="guessInput" class="input" placeholder="kelime tahmini..." style="width:260px" />
      <button id="guessBtn" class="btn">Gönder</button>
    </div>
    <div class="pill" style="justify-self:end; grid-column:3/4">Oda: <span id="roomName">-</span></div>
  </div>
</div>

<!-- Skor paneli (sağ-alt) -->
<aside class="scores" id="scores">
  <h3>Skorlar</h3>
  <div id="scoresBody"></div>
</aside>

<script type="module">
  import { GraphEngine } from '/engine.js';
  const socket = io();

  /* ==== Canvas + Engine ==== */
  const canvas = document.getElementById('canvas');
  const eng = new GraphEngine(canvas);
  let graphs = [];

  function rerender(){ eng.render(graphs); }
  window.addEventListener('resize', rerender);

  /* ==== UI elemanları ==== */
  const drawCtrls = document.getElementById('drawCtrls');
  const expr = document.getElementById('expr');
  const xmin = document.getElementById('xmin');
  const xmax = document.getElementById('xmax');
  const dx   = document.getElementById('dx');
  const dy   = document.getElementById('dy');
  const theta= document.getElementById('theta');
  const send = document.getElementById('send');
  const clear= document.getElementById('clear');

  const wordTxt = document.getElementById('wordTxt');
  const roomNameEl = document.getElementById('roomName');

  const guessBar = document.getElementById('guessBar');
  const guessInput = document.getElementById('guessInput');
  const guessBtn = document.getElementById('guessBtn');

  const scoresBody = document.getElementById('scoresBody');

  /* ==== Sayaç ==== */
  const ROUND_TOTAL = 180;
  let remaining = ROUND_TOTAL; let timerId = null;
  function setCountdown(sec){
    remaining = Math.max(0, sec|0);
    const m = String(Math.floor(remaining/60)).padStart(2,'0');
    const s = String(remaining%60).padStart(2,'0');
    document.getElementById('countdown').textContent = `${m}:${s}`;
    // bar
    const pct = Math.max(0, Math.min(1, remaining / ROUND_TOTAL));
    const bar = document.getElementById('timebar');
    bar.style.width = (pct*100).toFixed(2)+'%';
    if (pct <= .3) bar.style.background = 'linear-gradient(90deg,#ef4444,#b91c1c)';
    else if (pct <= .6) bar.style.background = 'linear-gradient(90deg,#f59e0b,#d97706)';
    else bar.style.background = 'linear-gradient(90deg,#b38a3e,#caa75b)';
  }
  function startTimer(){
    clearInterval(timerId); setCountdown(ROUND_TOTAL);
    timerId = setInterval(()=>{ setCountdown(remaining-1); if(remaining<=0) clearInterval(timerId); },1000);
  }
  function stopTimer(){ clearInterval(timerId); }

  /* ==== URL paramları ==== */
  const params = new URLSearchParams(location.search);
  const room = params.get('room'); const name = params.get('name');
  roomNameEl.textContent = room || '-';

  /* ==== Socket olayları ==== */
  socket.emit('join', { room, user: { name } });

  // Grafikler (server'dan gelen ham veriyi client'ta derle)
  socket.on('graphs', (arr = []) => {
    graphs = arr.map(g => {
      const type = g.type || GraphEngine.detectGraphType(g.expr);
      const cg = GraphEngine.compileGraph({
        type,
        expr: g.expr,
        color: g.color || '#4a3820',
        xmin: g.xmin,
        xmax: g.xmax,
      });
      cg.dx = g.dx || 0;
      cg.dy = g.dy || 0;
      cg.theta = g.theta || 0;
      return cg;
    });
    rerender();
  });

  socket.on('clearCanvas', () => { graphs = []; rerender(); });

  // Kullanıcı listesi -> skorları da yenileyelim
  socket.on('users', users => { renderScores(users); });

  // Yeni tur / kelime
  socket.on('newGame', ({ room: r }) => {
    startTimer();
    wordTxt.textContent = '?'; // painter gelene kadar gizli
  });
  socket.on('wordForPainter', word => {
    wordTxt.textContent = word; // sadece painter alır
  });

  // Tur bitti
  socket.on('round:end', ({ word, scores }) => {
    stopTimer(); wordTxt.textContent = word;
    renderScoresById(scores);
  });

  // Oyun sonu
  socket.on('gameOver', scores => {
    stopTimer(); renderScoresById(scores);
  });

  // Tahmin sonucu
  socket.on('guessResult', ({ correct, scores }) => {
    if (correct) renderScoresById(scores);
  });

  /* ==== Rol bilgisi ile UI kilitleme ==== */
  let myRole = 'viewer';
  socket.on('game:state', ({ players }) => {
    const me = players.find(p => p.name === name);
    myRole = me?.role || 'viewer';
    const painter = myRole === 'painter';
    drawCtrls.classList.toggle('hide', !painter);
    guessBar.classList.toggle('hide', painter);
  });

  /* ==== Çizim işlemleri ==== */
  function toRadians(deg){ return (Number(deg)||0) * Math.PI / 180; }
  send.onclick = () => {
    const gstr = (expr.value||'').trim();
    if (!gstr) return;
    const type = GraphEngine.detectGraphType(gstr);
    const graph = GraphEngine.compileGraph({
      type,
      expr: gstr,
      color: '#4a3820',
      xmin: Number(xmin.value||-10),
      xmax: Number(xmax.value||10),
    });
    // dönüş/öteleme
    graph.dx = Number(dx.value||0);
    graph.dy = Number(dy.value||0);
    graph.theta = toRadians(theta.value||0);

    socket.emit('addGraph', { room, graph });
  };
  clear.onclick = () => socket.emit('clearCanvas', { room });

  /* ==== Tahmin ==== */
  guessBtn.onclick = () => {
    const guess = (guessInput.value||'').trim();
    if (!guess) return;
    socket.emit('guess', { room, guess });
    guessInput.value = '';
  };

  /* ==== Skorlar ==== */
  function renderScores(users){
    scoresBody.innerHTML = '';
    (users||[]).forEach(u => {
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `<span>${u.name}</span><span id="sc_${u.id}">0</span>`;
      scoresBody.appendChild(row);
    });
  }
  function renderScoresById(scores){
    Object.entries(scores||{}).forEach(([id, sc]) => {
      const el = document.getElementById('sc_'+id);
      if (el) el.textContent = sc;
    });
  }

  // İlk çizim
  rerender();
</script>
</body>
</html>
