<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Matematik Oyunu</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
  :root{
    --bg:#0f1216; --canvasBorder:#2a3240; --grid:#253042; --axes:#d1b97b;
    --panel:#161a20; --card:#1b2027; --text:#e8edf3; --muted:#9aa6b2; --border:#2a3240;
    --accent:#3b82f6; --warn:#f59e0b; --danger:#ef4444; --good:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:Inter, system-ui, Arial, sans-serif}
  .game-container{
    max-width:1200px; margin:auto; padding:16px; display:grid; grid-template-columns:1fr 340px; gap:16px;
  }
  @media (max-width: 980px){
    .game-container{grid-template-columns:1fr}
    .sidebar{order:2}
    .canvas-area{order:1}
  }
  .canvas-area{
    background: #0b0f14; padding:12px; border:1px solid var(--canvasBorder); border-radius:14px;
  }
  canvas{width:100%; height:auto; max-height:70vh; border:2px solid var(--canvasBorder); background:#0b1016}
  .sidebar{
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px;
    position:sticky; top:12px; align-self:start;
  }
  h3,h4{margin:6px 0 10px}
  .game-info,.player-list,.controls,.scores{
    background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px;
  }
  .player{padding:6px 8px; border-radius:8px; margin:4px 0; background:#131922}
  .player.painter{background:#3a2b00; color:#fff7d6; font-weight:700}
  .hidden{display:none}
  input,button,label select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
    background:#0f141b; color:var(--text); outline:none; margin:6px 0;
  }
  input:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(59,130,246,.15)}
  button{background:linear-gradient(180deg,#3b82f6,#2563eb); border:none; font-weight:600; cursor:pointer}
  button.secondary{background:#1e293b}
  #wordToShow{background:#2b1f00; color:#fff1c2; border:1px dashed #8b6b00}
  /* countdown bar */
  .barWrap{height:10px; background:#1b2431; border-radius:999px; overflow:hidden; border:1px solid var(--border); margin-top:6px}
  .bar{height:100%; width:100%}
</style>
</head>
<body>
  <div class="game-container">
    <div class="canvas-area">
      <canvas id="canvas" width="800" height="600" style="border:2px solid #333"></canvas>
    </div>
    <div class="sidebar">
      <div class="game-info">
        <h3>Oyun Durumu</h3>
        <p id="gameStatus">Oyun başlatılıyor...</p>
        <p id="currentPainter"></p>
        <p><strong>Oda:</strong> <span id="roomLabel"></span></p>
        <p><strong>Süre:</strong> <span id="countdown">--:--</span></p>
        <p id="wordHint" class="hidden"></p>
      </div>

      <div class="player-list">
        <h4>Oyuncular</h4>
        <div id="playersList"></div>
      </div>

      <div class="controls">
        <div id="painterControls" class="hidden">
          <h4>Çizim Kontrolü</h4>
          <input id="expr" placeholder="y=sin(x)" />
          <label>x min: <input id="xmin" type="number" value="-10" /></label>
          <label>x max: <input id="xmax" type="number" value="10" /></label>
          <label>dx: <input id="dx" type="number" value="0" /></label>
          <label>dy: <input id="dy" type="number" value="0" /></label>
          <label>θ (derece): <input id="theta" type="number" value="0" /></label>
          <label>Renk: <input type="color" id="graphColor" value="#b00" /></label>
          <button id="sendGraph">Gönder</button>
          <button id="clearCanvas">Temizle</button>
          <div id="wordToShow" style="background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px;"></div>
        </div>

        <div id="viewerControls" class="hidden">
          <h4>Tahmin Et</h4>
          <input id="guessInput" placeholder="Kelime tahmini" />
          <button id="guessBtn">Tahmin Et</button>
        </div>
      </div>

      <div class="scores">
        <h4>Skorlar</h4>
        <div id="scoresList"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { GraphEngine } from './engine.js';
    import * as math from 'https://cdn.jsdelivr.net/npm/mathjs@11.11.0/+esm';

    const socket = io();
    const canvas = document.getElementById('canvas');
    const engine = new GraphEngine(canvas);
    let graphs = [];
    let currentRole = 'viewer';
    let currentWord = '';
    let players = [];
    let scores = {};
    let remainingTime = 180; // saniye
    let timerInterval;

    const params = new URLSearchParams(location.search);
    const room = params.get('room');
    const name = params.get('name');
    document.getElementById('roomLabel').textContent = room;

    if (!room || !name) {
      alert('Lütfen geçerli bir kullanıcı adı ve oda adı ile giriş yapınız.');
      window.location.href = '/index.html';
    }

    socket.emit('create', { room });
    socket.emit('join', { room, user: { name, role: 'viewer' } });

    // --- Yardımcılar ---
    function renderScores(sc = scores) {
      const scoresList = document.getElementById('scoresList');
      scoresList.innerHTML = '';
      Object.entries(sc).forEach(([id, score]) => {
        const player = players.find(p => p.id === id);
        if (player) {
          const div = document.createElement('div');
          div.className = 'score-item';
          div.innerHTML = `<span>${player.name}</span><span>${score}</span>`;
          scoresList.appendChild(div);
        }
      });
    }

    function renderPlayers(list) {
      const playersList = document.getElementById('playersList');
      playersList.innerHTML = '';
      list.forEach(u => {
        const div = document.createElement('div');
        div.className = `player ${u.role}`;
        div.textContent = u.name + (u.role === 'painter' ? ' (Çiziyor)' : '');
        playersList.appendChild(div);
      });
    }

    function applyRoleUI(role) {
      document.getElementById('painterControls').classList.toggle('hidden', role !== 'painter');
      document.getElementById('viewerControls').classList.toggle('hidden', role !== 'viewer');
    }

    function drawPreview() {
      if (currentRole !== 'painter') return;
      const expr = document.getElementById('expr').value.trim();
      if (!expr) return;

      const xmin = parseFloat(document.getElementById('xmin').value) || -10;
      const xmax = parseFloat(document.getElementById('xmax').value) || 10;
      const dx = parseFloat(document.getElementById('dx').value) || 0;
      const dy = parseFloat(document.getElementById('dy').value) || 0;
      const theta = (parseFloat(document.getElementById('theta').value) || 0) * Math.PI / 180;
      const color = document.getElementById('graphColor').value || '#b00';
      const previewColor = hexToRgba(color, 0.3);  // %30 opak

      const type = GraphEngine.detectGraphType(expr);
      let compiled;
      try {
        compiled = math.compile(expr.replace(/^y=/, ''));
      } catch { return; }

      const previewGraph = {
        type, expr, xmin, xmax, dx, dy, theta,
        color: previewColor, compiled, path: undefined
      };

      function hexToRgba(hex, alpha = 1.0) {
        hex = hex.replace('#', '');
        if (hex.length === 3) {
          hex = hex.split('').map(x => x + x).join('');
        }
        const r = parseInt(hex.substring(0,2), 16);
        const g = parseInt(hex.substring(2,4), 16);
        const b = parseInt(hex.substring(4,6), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      engine.render([...graphs, previewGraph]);
    }

    ['expr', 'xmin', 'xmax', 'dx', 'dy', 'theta', 'graphColor'].forEach(id => {
      document.getElementById(id).addEventListener('input', drawPreview);
    });

    document.getElementById('sendGraph').onclick = () => {
      if (currentRole !== 'painter') return;

      const expr = document.getElementById('expr').value.trim();
      if (!expr) return;

      const xmin = parseFloat(document.getElementById('xmin').value) || -10;
      const xmax = parseFloat(document.getElementById('xmax').value) || 10;
      const dx = parseFloat(document.getElementById('dx').value) || 0;
      const dy = parseFloat(document.getElementById('dy').value) || 0;
      const theta = (parseFloat(document.getElementById('theta').value) || 0) * Math.PI / 180;
      const color = document.getElementById('graphColor').value || '#b00';

      const type = GraphEngine.detectGraphType(expr);
      const compiled = math.compile(expr.replace(/^y=/, ''));

      const newGraph = { type, expr, xmin, xmax, dx, dy, theta, color, compiled };
      graphs.push(newGraph);
      engine.render(graphs);
      socket.emit('addGraph', { room, graph: newGraph });
    };

    document.getElementById('clearCanvas').onclick = () => {
      if (currentRole !== 'painter') return;
      graphs = [];
      engine.render(graphs);
      socket.emit('clearCanvas', { room });
    };

    document.getElementById('guessBtn').onclick = () => {
      // FIX: viewer kontrolünü client’ta kaldırdık; sunucu zaten doğruluyor.
      const guess = document.getElementById('guessInput').value.trim();
      if (guess) {
        socket.emit('guess', { room, guess }); // rol kontrolü sunucuda
        document.getElementById('guessInput').value = '';
      }
    };

    document.getElementById('guessInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') document.getElementById('guessBtn').click();
    });

    // --- Sunucu eventleri ---
    socket.on('graphs', g => {
      graphs = g.map(o => ({
        ...o,
        compiled: math.compile(o.expr.replace(/^y=/, '')),
        path: undefined
      }));
      engine.render(graphs);
    });

    socket.on('clearCanvas', () => {
      graphs = [];
      engine.render(graphs);
    });

    socket.on('users', users => {
      // FIX: users geldiğinde hem listeyi, hem rol UI’ını, hem skorları yenile
      players = users;
      renderPlayers(users);
      const me = users.find(p => p.id === socket.id);
      if (me) {
        currentRole = me.role;
        applyRoleUI(currentRole);
      }
      renderScores(); // isim değişimi vb. için yeniden çiz
    });

    socket.on('game:state', payload => {
      // FIX: merkezi durum güncellemesi — skor ve oyuncular buradan da akar
      if (payload?.players) {
        players = payload.players;
        renderPlayers(players);
        const me = players.find(p => p.id === socket.id);
        if (me) {
          currentRole = me.role;
          applyRoleUI(currentRole);
        }
      }
      if (payload?.scores) {
        scores = payload.scores;
        renderScores(scores);
      }
    });

    socket.on('round:end', ({ word, scores: sc } = {}) => {
      // FIX: tur bitiminde skoru güncelle
      if (sc) {
        scores = sc;
        renderScores(scores);
      }
      if (word) {
        document.getElementById('gameStatus').textContent = `Tur bitti. Kelime: ${word}`;
      }
    });

    socket.on('newGame', data => {
      const me = data.roles.find(p => p.id === socket.id);
      if (me) {
        currentRole = me.role;
        applyRoleUI(currentRole);
      }

      const painter = data.roles.find(p => p.role === 'painter');
      document.getElementById('currentPainter').textContent = painter ? `Çizen: ${painter.name}` : '';
      document.getElementById('gameStatus').textContent = 'Oyun devam ediyor...';

      graphs = [];
      engine.render(graphs);
      clearInterval(timerInterval);
      remainingTime = 180;
      updateCountdown(); // hemen başlat
      timerInterval = setInterval(() => {
        remainingTime--;
        updateCountdown();
        if (remainingTime <= 0) clearInterval(timerInterval);
      }, 1000);
    });

    function updateCountdown() {
      const min = Math.floor(remainingTime / 60).toString().padStart(2, '0');
      const sec = (remainingTime % 60).toString().padStart(2, '0');
      document.getElementById('countdown').textContent = `${min}:${sec}`;
    }

    socket.on('wordForPainter', word => {
      currentWord = word;
      document.getElementById('wordToShow').innerHTML = `<strong>Çizmen gereken kelime: ${word}</strong>`;
    });

    socket.on('gameOver', finalScores => {
      scores = finalScores;
      renderScores(scores);
      document.getElementById('gameStatus').textContent = 'Oyun bitti!';
      alert('Oyun bitti! Tüm oyuncular çizdi.');
    });

    socket.on('guessResult', res => {
      if (res.correct) {
        alert(`Doğru! Kelime: ${res.word}`);
        scores = res.scores;
        renderScores(scores); // ✔ anında güncelle
      } else {
        alert('Yanlış tahmin!');
      }
    });
  </script>
</body>
</html>
