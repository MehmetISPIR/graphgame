<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Matematik Oyunu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>

  <!-- Tema fontu -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">

  <style>
  /* Rol tabanlı görünürlük: tema tarafından ezilmesin */
  .hide, .hidden, [data-hidden="true"] {
    display: none !important;
    visibility: hidden !important;
    pointer-events: none !important;
  }

  /* ===== Victorian / Parşömen tema (yalnızca görsel) ===== */
  :root{
    --parchment:#f6efe1; --paper:#fffdf6; --ink:#2b1d0e; --muted:#6b5641;
    --gold:#b38a3e; --border:#d8c7a3; --shadow:0 14px 40px rgba(0,0,0,.18);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:
      radial-gradient(1200px 700px at 50% 0%, #f8f1e6 0%, #efe3cd 60%, #e6d5b5 100%),
      repeating-linear-gradient(10deg, #0000 0 24px, #00000006 24px 25px);
    color:var(--ink);
    font-family:"Libre Baskerville", Georgia, serif;
  }

  /* Dış çerçeve */
  .frame{
    max-width:1200px; margin:28px auto; padding:20px; background:var(--parchment);
    border:1px solid var(--gold); border-radius:10px; box-shadow:var(--shadow); position:relative;
  }
  .frame::before{
    content:""; position:absolute; inset:10px; border:3px double var(--gold); border-radius:8px; pointer-events:none;
  }

  /* İç kutu */
  .game-container{
    background:var(--paper); border:1px solid var(--border);
    border-radius:12px; padding:16px; box-shadow:inset 0 0 0 1px #ffffff80;
    display:grid; grid-template-columns: 1.4fr .6fr; gap:16px;
  }

  /* Canvas kutusu */
  .canvas-area{
    background:#fffdf9 !important; border:1px solid var(--border) !important; border-radius:12px !important;
    padding:10px;
  }
  #canvas{
    width:100%; height:auto; max-width:100%;
    background:#fffaf0 !important; border:1px solid #d8c7a3 !important; border-radius:10px;
  }

  /* Sağ panel */
  .sidebar{ background:transparent !important; border:none !important; padding:0 !important; }
  .section{
    background:var(--paper); border:1px solid var(--border);
    border-radius:12px; padding:14px; margin-bottom:12px;
    box-shadow: inset 0 0 0 1px #ffffff80;
  }

  /* Başlıklar */
  h3,h4{ color:var(--ink); margin:0 0 10px; }
  label{ color:var(--muted); }

  /* Inputlar */
  input[type="text"], input[type="number"], input[type="color"]{
    background:#fffdf9; color:var(--ink);
    border:1px solid var(--border); border-radius:10px; padding:10px 12px;
  }
  input:focus{ border-color:var(--gold); box-shadow:0 0 0 3px #b38a3e21; outline:none; }

  /* Butonlar */
  button{
    border:1px solid #8a6a2a; border-radius:10px; cursor:pointer;
    background:linear-gradient(#e9d6a6,#d6b86a); color:#3a2a0d; font-weight:700;
    padding:8px 14px;
  }
  button:hover{ filter:brightness(1.04); }
  button.secondary{ background:#efe3cd; }

  /* Esnek satır düzeni */
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .field{display:flex;align-items:center;gap:6px}
  .field label{font-size:13px;color:var(--muted)}
  .field input[type="text"], .field input[type="number"]{min-width:110px}

  /* Süre barı */
  .barWrap{ height:10px; background:#f1e6cb; border:1px solid var(--border); border-radius:6px; margin-top:6px; }
  #timebar{ height:100%; background:#b38a3e; width:100%; border-radius:6px; transition:width .25s linear; }

  /* Oyuncu listesi */
  .player{ background:#fff6e0; border:1px dashed #e4cf9f; color:var(--ink); padding:6px 8px; border-radius:8px; }
  .player + .player{ margin-top:6px; }
  .player.painter{ background:#fff0c2; color:#3a2a0d; font-weight:700; }

  /* Skorlar iki sütun */
  #scoresList{display:grid;grid-template-columns:1fr auto;gap:6px 12px}
  #scoresList .name{opacity:.9}
  #scoresList .pts{text-align:right;min-width:2ch}

  /* Painter kelime kutusu */
  #wordToShow{ background:#fff7e0; border:1px dashed #d4b06d; color:#3a2c18; padding:8px 10px; border-radius:8px; display:inline-block; margin-top:8px; }
  </style>
</head>
<body>
  <main class="frame">
    <div class="game-container">
      <div class="canvas-area">
        <canvas id="canvas" width="800" height="600"></canvas>
      </div>

      <div class="sidebar">
        <div class="game-info section">
          <h3>Oyun Durumu</h3>
          <p id="gameStatus">Oyun başlatılıyor...</p>
          <p id="currentPainter"></p>
          <p><strong>Oda:</strong> <span id="roomLabel"></span></p>
          <p><strong>Süre:</strong> <span id="countdown">--:--</span></p>
          <div class="barWrap"><div id="timebar" class="bar"></div></div>
          <p id="wordHint" class="hidden"></p>
        </div>

        <div class="player-list section">
          <h4>Oyuncular</h4>
          <div id="playersList"></div>
        </div>

        <div class="controls">
          <div id="painterControls" class="hidden section">
            <h4>Çizim Kontrolü</h4>

            <div class="row">
              <div class="field">
                <label for="expr">y =</label>
                <input id="expr" placeholder="sin(x) veya x*x+3" />
              </div>

              <div class="field">
                <label for="xmin">x min:</label>
                <input id="xmin" type="number" value="-10" />
              </div>

              <div class="field">
                <label for="xmax">x max:</label>
                <input id="xmax" type="number" value="10" />
              </div>

              <div class="field">
                <label for="dx">dx:</label>
                <input id="dx" type="number" value="0" />
              </div>

              <div class="field">
                <label for="dy">dy:</label>
                <input id="dy" type="number" value="0" />
              </div>

              <div class="field">
                <label for="theta">θ (°):</label>
                <input id="theta" type="number" value="0" />
              </div>

              <div class="field">
                <label for="graphColor">Renk:</label>
                <input type="color" id="graphColor" value="#b00" style="width:44px;height:32px;padding:0" />
              </div>

              <button id="sendGraph">Gönder</button>
              <button id="clearCanvas" class="secondary">Temizle</button>
            </div>

            <div id="wordToShow"></div>
          </div>

          <div id="viewerControls" class="hidden section">
            <h4>Tahmin Et</h4>
            <input id="guessInput" placeholder="Kelime tahmini" />
            <button id="guessBtn">Tahmin Et</button>
          </div>
        </div>

        <div class="scores section">
          <h4>Skorlar</h4>
          <div id="scoresList"></div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { GraphEngine } from './engine.js';
    import * as math from 'https://cdn.jsdelivr.net/npm/mathjs@11.11.0/+esm';

    const socket = io();
    const canvas = document.getElementById('canvas');
    const engine = new GraphEngine(canvas);
    let graphs = [];
    let currentRole = 'viewer';
    let currentWord = '';
    let players = [];
    let scores = {};
    let timerInterval;
    
    // Süre senkronizasyonu için değişkenler
    let roundStartTime = null;
    let roundDuration = 180; // saniye cinsinden varsayılan

    // URL parametreleri
    const params = new URLSearchParams(location.search);
    const room = params.get('room');
    const name = params.get('name');
    document.getElementById('roomLabel').textContent = room || '';

    if (!room || !name) {
      alert('Lütfen geçerli bir kullanıcı adı ve oda adı ile giriş yapınız.');
      window.location.href = '/index.html';
    }

    // Odaya giriş
    socket.emit('create', { room });
    socket.emit('join', { room, user: { name, role: 'viewer' } });

    // --- Yardımcılar ---
    function renderScores(sc = scores) {
      const scoresList = document.getElementById('scoresList');
      scoresList.innerHTML = '';
      Object.entries(sc).forEach(([id, score]) => {
        const player = players.find(p => p.id === id);
        if (!player) return;
        const row = document.createElement('div');
        row.innerHTML = `<span class="name">${player.name}</span><span class="pts">${score}</span>`;
        scoresList.appendChild(row);
      });
    }

    function renderPlayers(list) {
      const playersList = document.getElementById('playersList');
      playersList.innerHTML = '';
      list.forEach(u => {
        const div = document.createElement('div');
        div.className = `player ${u.role}`;
        div.textContent = u.name + (u.role === 'painter' ? ' (Çiziyor)' : '');
        playersList.appendChild(div);
      });
    }

    // Tek (merkezi) rol-görünürlük fonksiyonu
    function applyRoleUI(role) {
      const isPainter = role === 'painter';
      document.getElementById('painterControls').classList.toggle('hidden', !isPainter);
      document.getElementById('viewerControls').classList.toggle('hidden',  isPainter);
    }

    // Süre güncelleme fonksiyonu
    function updateCountdown() {
      if (!roundStartTime) {
        // Round aktif değilse varsayılan göster
        document.getElementById('countdown').textContent = '--:--';
        document.getElementById('timebar').style.width = '0%';
        return;
      }

      // Sunucu zamanına göre kalan süreyi hesapla
      const elapsed = Date.now() - roundStartTime;
      const remainingMs = Math.max(0, (roundDuration * 1000) - elapsed);
      const remainingSec = Math.floor(remainingMs / 1000);
      
      const min = Math.floor(remainingSec / 60).toString().padStart(2, '0');
      const sec = (remainingSec % 60).toString().padStart(2, '0');
      document.getElementById('countdown').textContent = `${min}:${sec}`;

      const bar = document.getElementById('timebar');
      if (bar) {
        const percentage = Math.max(0, remainingSec / roundDuration);
        bar.style.width = (percentage * 100) + '%';
      }
      
      // Süre bittiyse timer'ı durdur
      if (remainingMs <= 0) {
        clearInterval(timerInterval);
      }
    }

    // Canlı önizleme
    function drawPreview() {
      if (currentRole !== 'painter') return;
      const expr = document.getElementById('expr').value.trim();
      if (!expr) return;

      const xmin = parseFloat(document.getElementById('xmin').value) || -10;
      const xmax = parseFloat(document.getElementById('xmax').value) || 10;
      const dx = parseFloat(document.getElementById('dx').value) || 0;
      const dy = parseFloat(document.getElementById('dy').value) || 0;
      const theta = (parseFloat(document.getElementById('theta').value) || 0) * Math.PI / 180;
      const color = document.getElementById('graphColor').value || '#b00';
      const previewColor = hexToRgba(color, 0.3);  // %30 opak

      const type = GraphEngine.detectGraphType(expr);
      let compiled;
      try {
        compiled = math.compile(expr.replace(/^y=/, ''));
      } catch { return; }

      const previewGraph = {
        type, expr, xmin, xmax, dx, dy, theta,
        color: previewColor, compiled, path: undefined
      };

      engine.render([...graphs, previewGraph]);

      function hexToRgba(hex, alpha = 1.0) {
        hex = hex.replace('#', '');
        if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
        const r = parseInt(hex.substring(0,2), 16);
        const g = parseInt(hex.substring(2,4), 16);
        const b = parseInt(hex.substring(4,6), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }
    }

    ['expr', 'xmin', 'xmax', 'dx', 'dy', 'theta', 'graphColor'].forEach(id => {
      const el = document.getElementById(id);
      el && el.addEventListener('input', drawPreview);
    });

    // Gönder
    document.getElementById('sendGraph').onclick = () => {
      if (currentRole !== 'painter') return;

      const expr = document.getElementById('expr').value.trim();
      if (!expr) return;

      const xmin = parseFloat(document.getElementById('xmin').value) || -10;
      const xmax = parseFloat(document.getElementById('xmax').value) || 10;
      const dx   = parseFloat(document.getElementById('dx').value)   || 0;
      const dy   = parseFloat(document.getElementById('dy').value)   || 0;
      const theta = (parseFloat(document.getElementById('theta').value) || 0) * Math.PI / 180;
      const color = document.getElementById('graphColor').value || '#b00';

      const type = GraphEngine.detectGraphType(expr);
      const compiled = math.compile(expr.replace(/^y=/, ''));

      const newGraph = { type, expr, xmin, xmax, dx, dy, theta, color, compiled };
      graphs.push(newGraph);
      engine.render(graphs);
      socket.emit('addGraph', { room, graph: newGraph });
    };

    // Temizle
    document.getElementById('clearCanvas').onclick = () => {
      if (currentRole !== 'painter') return;
      graphs = [];
      engine.render(graphs);
      socket.emit('clearCanvas', { room });
    };

    // Tahmin
    document.getElementById('guessBtn').onclick = () => {
      const guess = document.getElementById('guessInput').value.trim();
      if (!guess) return;
      socket.emit('guess', { room, guess });
      document.getElementById('guessInput').value = '';
    };
    document.getElementById('guessInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') document.getElementById('guessBtn').click();
    });

    // --- Sunucu eventleri ---
    socket.on('graphs', g => {
      graphs = g.map(o => ({
        ...o,
        compiled: math.compile(o.expr.replace(/^y=/, '')),
        path: undefined
      }));
      engine.render(graphs);
    });

    socket.on('clearCanvas', () => {
      graphs = [];
      engine.render(graphs);
    });

    socket.on('users', users => {
      players = users;
      renderPlayers(users);
      const me = users.find(p => p.id === socket.id);
      if (me) {
        currentRole = me.role;
        applyRoleUI(currentRole);
      }
      renderScores(); // isim değişimi vb. için yeniden çiz
    });

    socket.on('game:state', payload => {
      if (payload?.players) {
        players = payload.players;
        renderPlayers(players);
        const me = players.find(p => p.id === socket.id);
        if (me) {
          currentRole = me.role;
          applyRoleUI(currentRole);
        }
      }
      if (payload?.scores) {
        scores = payload.scores;
        renderScores(scores);
      }
    });

    socket.on('round:end', ({ word, scores: sc } = {}) => {
      if (sc) { scores = sc; renderScores(scores); }
      if (word) {
        document.getElementById('gameStatus').textContent = `Tur bitti. Kelime: ${word}`;
      }
      
      // Round bittiğinde süre bilgilerini temizle
      clearInterval(timerInterval);
      roundStartTime = null;
      document.getElementById('countdown').textContent = '--:--';
      document.getElementById('timebar').style.width = '0%';
    });

    socket.on('newGame', data => {
      const me = data.roles.find(p => p.id === socket.id);
      if (me) {
        currentRole = me.role;
        applyRoleUI(currentRole);
      }
      const painter = data.roles.find(p => p.role === 'painter');
      document.getElementById('currentPainter').textContent = painter ? `Çizen: ${painter.name}` : '';
      document.getElementById('gameStatus').textContent = 'Oyun devam ediyor...';

      graphs = [];
      engine.render(graphs);

      // Sunucu zaman bilgilerini al
      if (data.roundStartTime && data.roundDuration) {
        roundStartTime = data.roundStartTime;
        roundDuration = data.roundDuration;
      } else {
        // Geriye uyumluluk için varsayılanlar
        roundStartTime = Date.now();
        roundDuration = 180;
      }

      // Timer'ı başlat - client kendi hesaplasını yapar
      clearInterval(timerInterval);
      updateCountdown(); // hemen güncelle
      
      timerInterval = setInterval(() => {
        updateCountdown();
      }, 1000);
    });

    socket.on('wordForPainter', word => {
      currentWord = word;
      document.getElementById('wordToShow').innerHTML = `<strong>Çizmen gereken kelime: ${word}</strong>`;
    });

    socket.on('gameOver', finalScores => {
      scores = finalScores;
      renderScores(scores);
      document.getElementById('gameStatus').textContent = 'Oyun bitti!';
      alert('Oyun bitti! Tüm oyuncular çizdi.');
      
      // Oyun bittiğinde timer'ı temizle
      clearInterval(timerInterval);
      roundStartTime = null;
      updateCountdown();
    });

    socket.on('guessResult', res => {
      if (res.correct) {
        alert(`Doğru! Kelime: ${res.word}`);
        scores = res.scores;
        renderScores(scores);
      } else {
        alert('Yanlış tahmin!');
      }
    });
  </script>
</body>
</html>
